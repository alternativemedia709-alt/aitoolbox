services:
  traefik:
    image: traefik:v2.11
    command: ["--configFile=/etc/traefik/traefik.yml"]
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./infra/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./infra/traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
    networks:
      - public
      - internal

  web:
    build: ./apps/web
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - NEXT_PUBLIC_SERVER_URL=http://localhost
      - PAYLOAD_SECRET=${PAYLOAD_SECRET}
      - REDIS_URL=redis://redis:6379/0
      - FLUX_API_URL=http://flux-api:8000
      - SOCIAL_API_URL=http://social-api:8000
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=Host(`${TRAEFIK_WEB_HOST}`)"
      - "traefik.http.routers.web.entrypoints=web"
      - "traefik.http.services.web.loadbalancer.server.port=3000"
    depends_on:
      - postgres
      - redis
    networks:
      - public
      - internal

  flux-api:
    build: ./services/flux-api
    environment:
      - FLUX_MODEL_DIR=/models/flux
      - HF_HUB_OFFLINE=1
      - TRANSFORMERS_OFFLINE=1
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - ${FLUX_MODEL_DIR}:/models/flux:ro
    depends_on:
      - redis
    networks:
      - internal

  social-api:
    build: ./services/social-api
    environment:
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - redis
    networks:
      - internal

  worker:
    build: ./worker
    environment:
      - REDIS_URL=redis://redis:6379/0
      - FLUX_MODEL_DIR=/models/flux
      - HF_HUB_OFFLINE=1
      - TRANSFORMERS_OFFLINE=1
      - JOB_QUEUE=JOB_QUEUE
      - FLUX_API_URL=http://flux-api:8000
    volumes:
      - ${FLUX_MODEL_DIR}:/models/flux:ro
    depends_on:
      - redis
    networks:
      - internal

  postgres:
    image: postgres:16
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - internal

  redis:
    image: redis:7
    volumes:
      - ./data/redis:/data
    networks:
      - internal

  ollama:
    image: ollama/ollama:latest
    volumes:
      - ./data/ollama:/root/.ollama
    networks:
      - internal

  ollama-init:
    image: ollama/ollama:latest
    environment:
      - OLLAMA_HOST=http://ollama:11434
    command: ["sh", "-c", "ollama pull bggpt9"]
    depends_on:
      - ollama
    volumes:
      - ./data/ollama:/root/.ollama
    networks:
      - internal
    restart: "no"

  gpu-check:
    image: nvidia/cuda:12.4.1-base-ubuntu22.04
    command: ["nvidia-smi"]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
    networks:
      - internal
    restart: "no"

networks:
  public:
  internal:
